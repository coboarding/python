version: '3.8'

services:
  llm-orchestrator-min:
    build:
      context: ./containers/llm-orchestrator-min
      args:
        BUILDKIT_INLINE_CACHE: 1
      cache_from:
        - llm-orchestrator-min:latest
    container_name: llm-orchestrator-min
    volumes:
      - ./volumes/models:/app/models
      - ./volumes/config:/app/config
      - pip-cache:/root/.cache/pip
      - models-cache:/app/models/tinyllama
      - wheel-cache:/root/.cache/pip/wheels
    environment:
      - USE_INT8=true
      - PYTHONUNBUFFERED=1
      - FLASK_ENV=production
      - PIP_CACHE_DIR=/root/.cache/pip
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    restart: unless-stopped
    ports:
      - "5000:5000"  # API LLM
    networks:
      - autoformfiller-min-network

  browser-service:
    build:
      context: ./containers/browser-service
      args:
        BUILDKIT_INLINE_CACHE: 1
      cache_from:
        - browser-service:latest
    container_name: browser-service
    volumes:
      - ./volumes/recordings:/app/recordings
      - pip-cache:/root/.cache/pip
      - wheel-cache:/root/.cache/pip/wheels
      - chrome-cache:/root/.cache/google-chrome
    environment:
      - DISPLAY=:99
      - PYTHONUNBUFFERED=1
      - PIP_CACHE_DIR=/root/.cache/pip
    deploy:
      resources:
        limits:
          memory: 1G
    restart: unless-stopped
    ports:
      - "5900:5900"  # VNC
    networks:
      - autoformfiller-min-network

  novnc:
    build:
      context: ./containers/novnc
      args:
        BUILDKIT_INLINE_CACHE: 1
      cache_from:
        - novnc:latest
    container_name: novnc
    deploy:
      resources:
        limits:
          memory: 256M
    restart: unless-stopped
    ports:
      - "8080:8080"  # noVNC Web UI
    networks:
      - autoformfiller-min-network
    depends_on:
      - browser-service

networks:
  autoformfiller-min-network:
    driver: bridge

volumes:
  pip-cache:
    name: coboarding-pip-cache
  wheel-cache:
    name: coboarding-wheel-cache
  models-cache:
    name: coboarding-models-cache
  chrome-cache:
    name: coboarding-chrome-cache
